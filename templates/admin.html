<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Weekplans - Admin Panel</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <style>
    body { background-color: #f8f9fa; }
    .card { margin-top: -1px; }
    .nav-tabs .nav-link.active { background-color: white; border-bottom-color: white; }
    .thumbnail { max-width: 150px; max-height: 150px; margin: 5px; border: 1px solid #dee2e6; border-radius: 4px; }
    .screensaver-item { text-align: center; padding: 10px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .pdf-preview { margin-top: 1rem; border: 1px solid #dee2e6; border-radius: 4px; padding: 10px; display: none; }
    .pdf-preview canvas { max-width: 100%; height: auto; }
    .status-indicator { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 8px; }
    .status-on { background-color: #198754; }
    .status-off { background-color: #dc3545; }
    .mqtt-controls-disabled { opacity: 0.55; }
  </style>
</head>
<body>
  <div class="container my-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h1 class="mb-0">Admin Panel</h1>
      <form id="showWeekplansForm" method="POST" action="{{ url_for('admin') }}" class="d-inline">
          <input type="hidden" name="action" value="show_week_plan">
          <input type="hidden" name="current_tab" id="showWeekplansTabInput" value="{{ current_tab }}">
          <input type="hidden" name="view" id="showViewInput" value="all">
          {% set p1 = (config.get('weekplans', [])|first) %}
          {% set p2 = (config.get('weekplans', [])|last) %}
          <div class="btn-group">
            <button id="showWeekplansPrimary" type="submit" class="btn btn-success">
              <i class="fas fa-calendar-week me-1"></i>Show Weekplans
            </button>
            <button type="button" class="btn btn-success dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false">
              <span class="visually-hidden">Toggle Dropdown</span>
            </button>
            <ul class="dropdown-menu">
              <li><button class="dropdown-item view-option" data-view="all" type="submit" name="view" value="all">All</button></li>
              <li><button class="dropdown-item view-option" data-view="plan1" type="submit" name="view" value="plan1">{{ p1.name if p1 else 'User 1' }}</button></li>
              <li><button class="dropdown-item view-option" data-view="plan2" type="submit" name="view" value="plan2">{{ p2.name if p2 else 'User 2' }}</button></li>
            </ul>
          </div>
      </form>
    </div>

    <!-- Navigation Tabs -->
    <ul class="nav nav-tabs" id="adminTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link {% if current_tab == 'ukeplan' %}active{% endif %}" data-bs-toggle="tab" data-bs-target="#ukeplan" type="button">Weekplans</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link {% if current_tab == 'screensaver' %}active{% endif %}" data-bs-toggle="tab" data-bs-target="#screensaver" type="button">Screensaver</button>
      </li>
       <li class="nav-item" role="presentation">
        <button class="nav-link {% if current_tab == 'controls' %}active{% endif %}" data-bs-toggle="tab" data-bs-target="#controls" type="button">Controls</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link {% if current_tab == 'settings' %}active{% endif %}" data-bs-toggle="tab" data-bs-target="#settings" type="button">Settings</button>
      </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="adminTabsContent">
      <!-- Ukeplan Tab -->
      <div class="tab-pane fade {% if current_tab == 'ukeplan' %}show active{% endif %}" id="ukeplan" role="tabpanel">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Upload New Weekplan</h5>
            <form method="POST" action="{{ url_for('admin') }}" enctype="multipart/form-data">
              <input type="hidden" name="action" value="upload_pdf">
              <input type="hidden" name="current_tab" value="ukeplan">
              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="pdf_file" class="form-label">Select PDF file (pages 1 and 2 will be used)</label>
                    <input type="file" class="form-control" name="pdf_file" id="pdf_file" accept=".pdf" required>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Select weekplan to update</label>
                    <div class="btn-group" role="group">
                      {% for plan in config.get('weekplans', []) %}
                        <input type="radio" class="btn-check" name="target" id="{{ plan.key }}" value="{{ plan.key }}" {% if loop.first %}checked{% endif %}>
                        <label class="btn btn-outline-primary" for="{{ plan.key }}">{{ plan.icon }} {{ plan.name }}</label>
                      {% endfor %}
                    </div>
                  </div>
                  <button type="submit" class="btn btn-primary"><i class="fas fa-upload me-1"></i>Upload & Update</button>
                </div>
                <div class="col-md-6">
                    <div id="pdfPreview" class="pdf-preview">
                      <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                          <button id="pdfPrev" type="button" class="btn btn-outline-secondary btn-sm" disabled>&larr; Prev</button>
                          <button id="pdfNext" type="button" class="btn btn-outline-secondary btn-sm ms-2" disabled>Next &rarr;</button>
                        </div>
                        <div class="text-muted small">Page <span id="pdfPageNum">1</span> / <span id="pdfPageCount">1</span></div>
                      </div>
                      <canvas id="pdfCanvas"></canvas>
                    </div>
                </div>
              </div>
            </form>
            <hr>
            <h5 class="mt-4">Current Weekplans</h5>
            <form method="POST" action="{{ url_for('admin') }}" class="mb-3">
              <input type="hidden" name="action" value="set_display_pages"><input type="hidden" name="current_tab" value="ukeplan">
              <div class="row">
              {% for plan in config.get('weekplans', []) %}
              <div class="col-md-6">
                <div class="text-center">
                  <h6>{{ plan.icon }} {{ plan.name }}</h6>
                  <div class="d-flex gap-2 justify-content-center">
                    <img src="{{ url_for('static', filename='images/' + plan.key + '-ukeplan.png') }}?v={{ last_updates.get(plan.key).timestamp() if last_updates.get(plan.key) else 0 }}" class="img-fluid border rounded mb-2" style="max-width:48%" alt="Current weekplan page 1 for {{ plan.name }}">
                    <img src="{{ url_for('static', filename='images/' + plan.key + '-ukeplan-2.png') }}?v={{ last_updates.get(plan.key).timestamp() if last_updates.get(plan.key) else 0 }}" onerror="this.style.display='none'" class="img-fluid border rounded mb-2" style="max-width:48%" alt="Current weekplan page 2 for {{ plan.name }}">
                  </div>
                  <div class="d-flex justify-content-center gap-3 align-items-center mb-2">
                    <div class="form-check">
                      <input class="form-check-input" type="radio" name="display_page_{{ plan.key }}" id="disp1_{{ plan.key }}" value="1" {% if plan.display_page|default(1) == 1 %}checked{% endif %}>
                      <label class="form-check-label" for="disp1_{{ plan.key }}">Show page 1 in All view</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="radio" name="display_page_{{ plan.key }}" id="disp2_{{ plan.key }}" value="2" {% if plan.display_page|default(1) == 2 %}checked{% endif %}>
                      <label class="form-check-label" for="disp2_{{ plan.key }}">Show page 2 in All view</label>
                    </div>
                  </div>
                  <p class="text-muted small">Last updated: {{ last_updates.get(plan.key).strftime("%-d %B %Y, %H:%M") if last_updates.get(plan.key) else 'Never' }}</p>
                </div>
              </div>
              {% endfor %}
              </div>
              <div class="text-center">
                <button type="submit" class="btn btn-primary"><i class="fas fa-save me-1"></i>Save Display Pages</button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Screensaver Tab -->
      <div class="tab-pane fade {% if current_tab == 'screensaver' %}show active{% endif %}" id="screensaver" role="tabpanel">
        <div class="card">
          <div class="card-body">
            <form method="POST" action="{{ url_for('admin') }}" enctype="multipart/form-data" class="mb-3">
                <input type="hidden" name="action" value="upload_screensaver_file">
                <input type="hidden" name="current_tab" value="screensaver">
                <div class="row g-3 align-items-end">
                    <div class="col">
                        <label for="screensaver_file" class="form-label">Upload from computer</label>
                        <input type="file" class="form-control" name="screensaver_file" id="screensaver_file" accept="image/*" required>
                    </div>
                    <div class="col-auto">
                        <button type="submit" class="btn btn-primary"><i class="fas fa-upload me-1"></i>Upload File</button>
                    </div>
                </div>
            </form>
            <form method="POST" action="{{ url_for('admin') }}" class="mb-4">
                <input type="hidden" name="action" value="upload_screensaver_url">
                <input type="hidden" name="current_tab" value="screensaver">
                <div class="row g-3 align-items-end">
                    <div class="col">
                        <label for="screensaver_url" class="form-label">Or upload from URL</label>
                        <input type="url" class="form-control" name="screensaver_url" id="screensaver_url" placeholder="https://example.com/image.jpg" required>
                    </div>
                    <div class="col-auto">
                        <button type="submit" class="btn btn-primary"><i class="fas fa-link me-1"></i>Upload from URL</button>
                    </div>
                </div>
            </form>
            <hr>
            <h5 class="mt-4">Manage Screensavers</h5>
            <form id="activationForm" method="POST" action="{{ url_for('admin') }}">
                <input type="hidden" name="action" value="update_screensaver_activation">
                <input type="hidden" name="current_tab" value="screensaver">
            </form>
            <div class="d-flex flex-wrap gap-3">
              {% for item in config.get("screensaver_config", []) %}
              <div class="screensaver-item">
                  <img src="{{ url_for('static', filename='screensaver/' ~ item.filename) }}" class="thumbnail">
                  <div class="mt-2 d-flex justify-content-around align-items-center">
                      <div class="form-check">
                          <input class="form-check-input" type="checkbox" name="active_images" value="{{ item.filename }}" id="active_{{ loop.index }}" {% if item.active %}checked{% endif %} form="activationForm">
                          <label class="form-check-label" for="active_{{ loop.index }}">Active</label>
                      </div>
                      <form method="POST" action="{{ url_for('admin') }}" class="m-0" onsubmit="return confirm('Are you sure you want to delete this image?');">
                         <input type="hidden" name="action" value="delete_screensaver">
                         <input type="hidden" name="current_tab" value="screensaver">
                         <input type="hidden" name="filename" value="{{ item.filename }}">
                         <button type="submit" class="btn btn-danger btn-sm"><i class="fas fa-trash"></i></button>
                      </form>
                  </div>
              </div>
              {% endfor %}
            </div>
            <button type="submit" class="btn btn-primary mt-3" form="activationForm"><i class="fas fa-save me-1"></i>Update Activation Status</button>
          </div>
        </div>
      </div>
      
      <!-- Controls Tab -->
      <div class="tab-pane fade {% if current_tab == 'controls' %}show active{% endif %}" id="controls" role="tabpanel">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">System Controls & Status</h5>
                <div class="row">
                    <div class="col-md-6">
                        <h6>Commands</h6>
                        {% set mqtt_enabled = config.get('enable_mqtt') %}
                        {% set mqtt_ready = mqtt_connected %}
                        {% if not mqtt_enabled %}
                          <div class="alert alert-warning d-flex align-items-center mt-2" role="alert">
                            <i class="fas fa-circle-exclamation me-2"></i>
                            <div>
                              MQTT is not enabled. These controls send commands over MQTT and will not work until it is turned on.
                      <button type="button" class="btn btn-sm btn-outline-secondary ms-2" data-go-to-tab="settings">
                                Go to MQTT settings
                              </button>
                            </div>
                          </div>
                        {% elif mqtt_enabled and not mqtt_ready %}
                          <div class="alert alert-warning d-flex align-items-center mt-2" role="alert">
                            <i class="fas fa-triangle-exclamation me-2"></i>
                            <div>
                              MQTT is enabled, but the connection is not active. Controls are disabled until the broker is reachable.
                            </div>
                          </div>
                        {% else %}
                          <div class="alert alert-info d-flex align-items-center mt-2" role="alert">
                            <i class="fas fa-info-circle me-2"></i>
                            <div>Controls send commands over MQTT to the display device.</div>
                          </div>
                        {% endif %}
                        <fieldset {% if not mqtt_ready %}disabled{% endif %} class="{% if not mqtt_ready %}mqtt-controls-disabled{% endif %}">
                          <div class="mb-3">
                              <p class="mb-1">Change Browser URL</p>
                              <div class="text-muted small mb-2">Sets the display device’s browser URL via MQTT.</div>
                              <form method="POST" action="{{ url_for('admin') }}">
                                  <input type="hidden" name="action" value="browser_url">
                                  <input type="hidden" name="current_tab" value="controls">
                                  <div class="input-group">
                                      <input type="url" class="form-control" name="url" placeholder="{{ mqtt_stats['pi/browser/current_url'] }}" required>
                                      <button type="submit" class="btn btn-outline-primary"><i class="fas fa-external-link-alt"></i></button>
                                  </div>
                              </form>
                          </div>
                          <div class="mb-3">
                              <form method="POST" action="{{ url_for('admin') }}">
                                  <input type="hidden" name="action" value="set_brightness">
                                  <input type="hidden" name="current_tab" value="controls">
                                  <label for="brightness" class="form-label">Brightness: <span id="brightnessDisplay">{{ (mqtt_stats['pi/brightness/state']|float * 100)|round }}</span>%</label>
                                  <div class="d-flex align-items-center">
                                      <input type="range" class="form-range me-3" id="brightness" name="brightness" min="0" max="100" value="{{ (mqtt_stats['pi/brightness/state']|float * 100)|round }}">
                                      <button type="submit" class="btn btn-outline-primary btn-sm">Set</button>
                                  </div>
                              </form>
                          </div>
                          <hr>
                          <div class="mb-3">
                              <p class="mb-1">Display Control</p>
                              <div class="text-muted small mb-2">Turns the display on or off.</div>
                              <form method="POST" action="{{ url_for('admin') }}" class="d-inline">
                                  <input type="hidden" name="action" value="display_on"><input type="hidden" name="current_tab" value="controls">
                                  <button type="submit" class="btn btn-outline-success">Turn ON</button>
                              </form>
                              <form method="POST" action="{{ url_for('admin') }}" class="d-inline">
                                  <input type="hidden" name="action" value="display_off"><input type="hidden" name="current_tab" value="controls">
                                  <button type="submit" class="btn btn-outline-danger">Turn OFF</button>
                              </form>
                              <div class="mt-2 text-muted small">Current state: {{ mqtt_stats['pi/display/state']|default('unknown') }}</div>
                          </div>
                          <div class="mb-3">
                             <p class="mb-1">System</p>
                             <div class="text-muted small mb-2">Reboots the device running the display.</div>
                              <form id="restartForm" method="POST" action="{{ url_for('admin') }}">
                                  <input type="hidden" name="action" value="system_restart"><input type="hidden" name="current_tab" value="controls">
                                  <button type="button" class="btn btn-outline-warning" onclick="confirmRestart()">Restart System</button>
                              </form>
                          </div>
                          <div class="mb-3">
                             <p class="mb-1">Browser</p>
                             <div class="text-muted small mb-2">Reloads the kiosk browser on the display device.</div>
                             <form method="POST" action="{{ url_for('admin') }}" class="d-inline">
                                 <input type="hidden" name="action" value="browser_refresh"><input type="hidden" name="current_tab" value="controls">
                                 <button type="submit" class="btn btn-outline-secondary">Refresh Browser</button>
                             </form>
                             <div class="mt-2 text-muted small">Current URL: {{ mqtt_stats['pi/browser/current_url']|default('') }}</div>
                          </div>
                        </fieldset>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                           <h6>Live Status</h6>
                           <button id="refreshStatus" class="btn btn-sm btn-secondary"><i class="fas fa-sync-alt"></i></button>
                        </div>
                        <ul class="list-group" id="statusContent">
                            <li class="list-group-item"><strong>Uptime:</strong> <span id="uptime">{{ system_stats.uptime }}</span></li>
                            <li class="list-group-item"><strong>Start Time:</strong> <span id="start_time">{{ system_stats.start_time }}</span></li>
                            <li class="list-group-item"><strong>Memory Usage:</strong> <span id="memory_usage">{{ system_stats.memory_usage }}</span></li>
                            <li class="list-group-item"><strong>Memory Limit:</strong> <span id="memory_limit">{{ system_stats.memory_limit }}</span></li>
                            <li class="list-group-item"><strong>Container ID:</strong> <span id="container_id">{{ system_stats.container_id }}</span></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
      </div>

      <!-- Settings Tab -->
      <div class="tab-pane fade {% if current_tab == 'settings' %}show active{% endif %}" id="settings" role="tabpanel">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Application Settings</h5>
                
                <hr><h6>General</h6>
                <form method="POST" action="{{ url_for('admin') }}" class="mb-4">
                    <input type="hidden" name="action" value="set_duration"><input type="hidden" name="current_tab" value="settings">
                    <div class="mb-3">
                        <label for="dashboard_duration" class="form-label">Dashboard Display Duration: <span id="durationDisplay">{{ config.get('dashboard_duration', 10) }}</span>s</label>
                        <input type="range" class="form-range" id="dashboard_duration" name="dashboard_duration" min="5" max="300" step="5" value="{{ config.get('dashboard_duration', 10) }}">
                    </div>
                    <div class="row">
                      <div class="col-md-6">
                        <label for="dashboard_language" class="form-label">Dashboard Language</label>
                        <select class="form-select" id="dashboard_language" name="dashboard_language">
                          {% set lang = config.get('dashboard_language', 'en-GB') %}
                          <option value="en-GB" {% if lang == 'en-GB' %}selected{% endif %}>English (UK)</option>
                          <option value="nb-NO" {% if lang == 'nb-NO' %}selected{% endif %}>Norwegian Bokmål</option>
                        </select>
                      </div>
                    </div>
                    <button type="submit" class="btn btn-primary mt-3" data-bs-toggle="tooltip" title="Saves only the dashboard duration and language."><i class="fas fa-save me-1"></i>Save General Settings</button>
                </form>

                <hr><h6>Weekplan Details</h6>
                <form method="POST" action="{{ url_for('admin') }}" class="mb-4">
                    <input type="hidden" name="action" value="set_weekplan_details"><input type="hidden" name="current_tab" value="settings">
                    <div class="row">
                        {% for plan in config.get('weekplans', []) %}
                        <div class="col-md-6 mb-3">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h6 class="card-title">Weekplan {{ loop.index }}</h6>
                                    <div class="row align-items-end">
                                        <div class="col-3">
                                            <label class="form-label">Icon <i class="fas fa-info-circle text-muted" data-bs-toggle="tooltip" title="Use an emoji or short text"></i></label>
                                            <input type="text" class="form-control" name="icon_{{ plan.key }}" value="{{ plan.icon }}">
                                        </div>
                                        <div class="col-9">
                                            <label class="form-label">Name</label>
                                            <input type="text" class="form-control" name="name_{{ plan.key }}" value="{{ plan.name }}">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <button type="submit" class="btn btn-primary" data-bs-toggle="tooltip" title="Saves only the weekplan names and icons."><i class="fas fa-save me-1"></i>Set Weekplan Details</button>
                </form>

                <hr><h6>Screensaver Buttons</h6>
                <p class="text-muted mb-3">Optional buttons shown on the screensaver screen. Enable and customize each button. Labels appear on the screensaver when the option is active.</p>
                <form method="POST" action="{{ url_for('admin') }}" class="mb-4">
                    <input type="hidden" name="action" value="set_screensaver_buttons"><input type="hidden" name="current_tab" value="settings">
                    {% set pos = config.get('screensaver_buttons_position', {}) or {} %}
                    <div class="card mb-3">
                        <div class="card-body">
                            <h6 class="card-title">Button group position</h6>
                            <div class="row">
                                <div class="col-md-6 mb-2">
                                    <label for="screensaver_buttons_horizontal" class="form-label small mb-0">Horizontal</label>
                                    <select class="form-select form-select-sm" name="screensaver_buttons_horizontal" id="screensaver_buttons_horizontal">
                                        <option value="left" {% if pos.get('horizontal') == 'left' %}selected{% endif %}>Left</option>
                                        <option value="center" {% if pos.get('horizontal', 'center') == 'center' %}selected{% endif %}>Center</option>
                                        <option value="right" {% if pos.get('horizontal') == 'right' %}selected{% endif %}>Right</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-2">
                                    <label for="screensaver_buttons_vertical" class="form-label small mb-0">Vertical</label>
                                    <select class="form-select form-select-sm" name="screensaver_buttons_vertical" id="screensaver_buttons_vertical">
                                        <option value="top" {% if pos.get('vertical') == 'top' %}selected{% endif %}>Top</option>
                                        <option value="center" {% if pos.get('vertical') == 'center' %}selected{% endif %}>Center</option>
                                        <option value="bottom" {% if pos.get('vertical', 'bottom') == 'bottom' %}selected{% endif %}>Bottom</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% set btn_configs = [
                      ('Show Weekplan 1', 'plan1', false),
                      ('Show Weekplan 2', 'plan2', false),
                      ('Show both weekplans', 'all', false),
                      ('Custom URL', 'url', true)
                    ] %}
                    {% set screensaver_btns = config.get('screensaver_buttons', []) %}
                    {% for i in range(4) %}
                    {% set btn = screensaver_btns[i] if i < screensaver_btns|length else {} %}
                    {% set default_label = btn_configs[i][0] %}
                    {% set is_url = btn_configs[i][2] %}
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="row align-items-center flex-wrap">
                                <div class="col-auto">
                                    <div class="form-check form-switch mb-0">
                                        <input class="form-check-input" type="checkbox" name="screensaver_btn_{{ i }}_enabled" id="screensaver_btn_{{ i }}_enabled" {% if btn.get('enabled') %}checked{% endif %} value="1">
                                        <label class="form-check-label" for="screensaver_btn_{{ i }}_enabled">Enable</label>
                                    </div>
                                </div>
                                <div class="col">
                                    <label for="screensaver_btn_{{ i }}_label" class="form-label small mb-0">Button label</label>
                                    <input type="text" class="form-control form-control-sm" name="screensaver_btn_{{ i }}_label" id="screensaver_btn_{{ i }}_label" value="{{ btn.get('label', default_label) }}" placeholder="{{ default_label }}">
                                </div>
                                {% if is_url %}
                                <div class="col">
                                    <label for="screensaver_btn_{{ i }}_url" class="form-label small mb-0">URL (opens in browser when pressed)</label>
                                    <input type="url" class="form-control form-control-sm" name="screensaver_btn_{{ i }}_url" id="screensaver_btn_{{ i }}_url" value="{{ btn.get('url', '') }}" placeholder="https://example.com">
                                </div>
                                {% endif %}
                                <div class="col-auto">
                                    <div class="form-check form-switch mb-1">
                                        <input class="form-check-input" type="checkbox" name="screensaver_btn_{{ i }}_use_custom_color" id="screensaver_btn_{{ i }}_use_custom_color" {% if btn.get('use_custom_color') %}checked{% endif %} value="1">
                                        <label class="form-check-label" for="screensaver_btn_{{ i }}_use_custom_color">Custom colour</label>
                                    </div>
                                    <div class="d-flex align-items-center gap-1">
                                        <input type="color" class="form-control form-control-color" name="screensaver_btn_{{ i }}_color" id="screensaver_btn_{{ i }}_color" value="{{ btn.get('color', '#ffffff') }}" title="Button colour">
                                        <label for="screensaver_btn_{{ i }}_color" class="form-label small mb-0 text-muted">Colour</label>
                                    </div>
                                </div>
                                <div class="col-auto">
                                    <label for="screensaver_btn_{{ i }}_font_color" class="form-label small mb-0">Font colour</label>
                                    <select class="form-select form-select-sm" name="screensaver_btn_{{ i }}_font_color" id="screensaver_btn_{{ i }}_font_color">
                                        <option value="auto" {% if btn.get('font_color', 'auto') == 'auto' %}selected{% endif %}>Auto</option>
                                        <option value="white" {% if btn.get('font_color') == 'white' %}selected{% endif %}>White</option>
                                        <option value="black" {% if btn.get('font_color') == 'black' %}selected{% endif %}>Black</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    <button type="submit" class="btn btn-primary" data-bs-toggle="tooltip" title="Saves screensaver button settings."><i class="fas fa-save me-1"></i>Save Screensaver Buttons</button>
                </form>

                <hr><h6 id="mqtt-config">MQTT Configuration
                  <i class="fas fa-info-circle text-muted ms-2"
                     data-bs-toggle="tooltip"
                     data-bs-html="true"
                     title="MQTT is used to send control commands to your display device.<br><br>
                     Topics:<br>
                     • pi/display/command — on/off<br>
                     • pi/browser/command/url — change URL<br>
                     • pi/browser/command/refresh — refresh browser<br>
                     • pi/system/command/restart — reboot device<br>
                     • pi/brightness/command — set brightness<br><br>
                     Broker is the host running MQTT. Credentials are optional if your broker requires them."></i>
                </h6>
                {% if mqtt_externally_controlled %}
                <div class="alert alert-info py-2 mb-3" role="alert">
                  <i class="fas fa-info-circle me-2"></i>{% if mqtt_env_controlled %}Set in Docker environment variable. To change, update your container's environment variables and restart.{% else %}Configured in Home Assistant app settings. To change, use the app configuration in Home Assistant.{% endif %}
                </div>
                {% endif %}
                <form method="POST" action="{{ url_for('admin') }}">
                    <input type="hidden" name="action" value="set_mqtt_config"><input type="hidden" name="current_tab" value="settings">
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" name="enable_mqtt" id="enable_mqtt" {% if config.get('enable_mqtt') %}checked{% endif %} {% if mqtt_externally_controlled %}disabled{% endif %}>
                        <label class="form-check-label {% if mqtt_externally_controlled %}text-muted{% endif %}" for="enable_mqtt">Enable MQTT Integration</label>
                    </div>
                    <div class="row">
                        <div class="col-md-9 mb-3">
                          <label for="mqtt_broker" class="form-label {% if mqtt_externally_controlled %}text-muted{% endif %}">MQTT Broker</label>
                          <input type="text" class="form-control" id="mqtt_broker" name="mqtt_broker" value="{{ config.get('mqtt_broker', 'homeassistant.local') }}" {% if mqtt_externally_controlled %}readonly disabled{% endif %}>
                          <div class="form-text">Hostname or IP of your MQTT server.</div>
                        </div>
                        <div class="col-md-3 mb-3">
                          <label for="mqtt_port" class="form-label {% if mqtt_externally_controlled %}text-muted{% endif %}">Port</label>
                          <input type="number" class="form-control" id="mqtt_port" name="mqtt_port" value="{{ config.get('mqtt_port', 1883) }}" {% if mqtt_externally_controlled %}readonly disabled{% endif %}>
                          <div class="form-text">Default is 1883 for MQTT.</div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                          <label for="mqtt_user" class="form-label {% if mqtt_externally_controlled %}text-muted{% endif %}">Username (optional)</label>
                          <input type="text" class="form-control" id="mqtt_user" name="mqtt_user" value="{{ config.get('mqtt_user', '') }}" {% if mqtt_externally_controlled %}readonly disabled{% endif %}>
                          <div class="form-text">Leave blank if your broker allows anonymous access.</div>
                        </div>
                        <div class="col-md-6 mb-3">
                          <label for="mqtt_pass" class="form-label {% if mqtt_externally_controlled %}text-muted{% endif %}">Password (optional)</label>
                          <input type="password" class="form-control" id="mqtt_pass" name="mqtt_pass" value="{{ config.get('mqtt_pass', '') }}" {% if mqtt_externally_controlled %}readonly disabled{% endif %}>
                          <div class="form-text">Only required when authentication is enabled on the broker.</div>
                        </div>
                    </div>
                    <div class="d-flex align-items-center">
                        <button type="submit" class="btn btn-primary" data-bs-toggle="tooltip" title="Saves only the MQTT settings." {% if mqtt_externally_controlled %}disabled{% endif %}><i class="fas fa-save me-1"></i>Set MQTT Configuration</button>
                        <div class="ms-4 d-flex align-items-center">
                           <div class="status-indicator {% if mqtt_connected %}status-on{% else %}status-off{% endif %}"></div>
                           <span>Status: {% if mqtt_connected %}Connected{% else %}Not Connected{% endif %}</span>
                       </div>
                    </div>
                </form>

                <hr><h6>Calendar Integration</h6>
                <div class="mb-4">
                    <p class="text-muted mb-3">Add Google Calendar or other iCal URLs to display upcoming events for the next 2 weeks.</p>
                    
                    <!-- Add Calendar Form -->
                    <form method="POST" action="{{ url_for('admin') }}" class="mb-3">
                        <input type="hidden" name="action" value="add_calendar">
                        <input type="hidden" name="current_tab" value="settings">
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label for="calendar_name" class="form-label">Calendar Name</label>
                                <input type="text" class="form-control" id="calendar_name" name="calendar_name" placeholder="e.g., Family Calendar" required>
                            </div>
                            <div class="col-md-5 mb-3">
                                <label for="calendar_url" class="form-label">iCal URL</label>
                                <input type="url" class="form-control" id="calendar_url" name="calendar_url" placeholder="https://calendar.google.com/calendar/ical/..." required>
                            </div>
                            <div class="col-md-2 mb-3">
                                <label for="calendar_color" class="form-label">Color</label>
                                <div class="d-flex align-items-center">
                                    <input type="color" class="form-control form-control-color" id="calendar_color" name="calendar_color" value="#3788d8" title="Choose calendar color">
                                </div>
                            </div>
                            <div class="col-md-2 mb-3 d-flex align-items-end">
                                <button type="submit" class="btn btn-success w-100"><i class="fas fa-plus me-1"></i>Add</button>
                            </div>
                        </div>
                    </form>

                    <!-- Calendar List -->
                    {% if config.get('calendar_urls') %}
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">Configured Calendars</h6>
                            <button type="button" class="btn btn-primary btn-sm" onclick="document.getElementById('calendar_assignments_form').submit();">
                                <i class="fas fa-save me-1"></i>Save Assignments
                            </button>
                        </div>
                        <div class="card-body">
                            {% for calendar in config.get('calendar_urls', []) %}
                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="d-flex align-items-center">
                                        <div class="me-3">
                                            <div style="width: 20px; height: 20px; background-color: {{ calendar.get('color', '#3788d8') }}; border-radius: 50%; border: 2px solid #fff; box-shadow: 0 0 0 1px rgba(0,0,0,0.1);"></div>
                                        </div>
                                        <div>
                                            <strong>{{ calendar.name }}</strong><br>
                                            <small class="text-muted">{{ calendar.url[:50] }}{% if calendar.url|length > 50 %}...{% endif %}</small>
                                        </div>
                                    </div>
                                    <form method="POST" action="{{ url_for('admin') }}" class="mb-0">
                                        <input type="hidden" name="action" value="remove_calendar">
                                        <input type="hidden" name="current_tab" value="settings">
                                        <input type="hidden" name="calendar_id" value="{{ calendar.id }}">
                                        <input type="hidden" name="calendar_url" value="{{ calendar.url }}">
                                        <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Remove this calendar?')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </form>
                                </div>
                                <div class="mt-2">
                                    <div class="text-muted small mb-1">Assigned to:</div>
                                    <div class="d-flex flex-wrap gap-3">
                                        {% for plan in config.get('weekplans', []) %}
                                            {% set assigned_ids = (config.get('calendar_assignments', {}).get(plan.key, [])) %}
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" form="calendar_assignments_form" name="assign_{{ plan.key }}" id="assign_{{ plan.key }}_{{ calendar.id }}" value="{{ calendar.id }}" {% if calendar.id in assigned_ids %}checked{% endif %}>
                                                <label class="form-check-label" for="assign_{{ plan.key }}_{{ calendar.id }}">{{ plan.icon }} {{ plan.name }}</label>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                            {% if not loop.last %}<hr>{% endif %}
                            {% endfor %}
                        </div>
                    </div>
                    <form method="POST" action="{{ url_for('admin') }}" id="calendar_assignments_form">
                        <input type="hidden" name="action" value="set_calendar_assignments">
                        <input type="hidden" name="current_tab" value="settings">
                    </form>
                    <!-- Calendar Events Display -->
                    <div class="mt-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0">Upcoming Events (Next 2 Weeks)</h6>
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="loadCalendarEvents()">
                                <i class="fas fa-refresh me-1"></i>Refresh
                            </button>
                        </div>
                        <div id="calendar-events" class="card">
                            <div class="card-body text-center text-muted">
                                <i class="fas fa-calendar-alt fa-2x mb-2"></i><br>
                                Click "Refresh" to load events
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>No calendars configured. Add a calendar URL above to get started.
                    </div>
                    {% endif %}
                </div>

                
            </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="{{ url_for('static', filename='js/admin.js') }}"></script>
  <script>
    // This script ensures the "Show Weekplans" button knows which tab is currently active.
    document.addEventListener('DOMContentLoaded', function() {
      const tabButtons = document.querySelectorAll('button[data-bs-toggle="tab"]');
      const showWeekplansTabInput = document.getElementById('showWeekplansTabInput');
  
      if (tabButtons.length > 0 && showWeekplansTabInput) {
        tabButtons.forEach(button => {
          button.addEventListener('shown.bs.tab', function (event) {
            // Get the ID of the new tab from its 'data-bs-target' attribute (e.g., "#ukeplan")
            const newTabId = event.target.getAttribute('data-bs-target').substring(1);
            // Update the hidden input's value to the new tab's ID
            showWeekplansTabInput.value = newTabId;
          });
        });
      }
    });
  </script>
  <script>
    // Persist last selected view for the Show Weekplans primary button
    document.addEventListener('DOMContentLoaded', function() {
      const form = document.getElementById('showWeekplansForm');
      const viewInput = document.getElementById('showViewInput');
      const options = document.querySelectorAll('.view-option');
      const STORAGE_KEY = 'weekplans:lastView';

      // Load last view or default to 'all'
      try {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) viewInput.value = saved;
      } catch (e) {}

      // When an option is clicked, update hidden input and persist
      options.forEach(btn => {
        btn.addEventListener('click', function(e) {
          const v = this.getAttribute('data-view') || 'all';
          viewInput.value = v;
          try { localStorage.setItem(STORAGE_KEY, v); } catch (e) {}
        });
      });

      // Also persist on primary submit (it uses whatever value is currently set)
      if (form) {
        form.addEventListener('submit', function() {
          try { localStorage.setItem(STORAGE_KEY, viewInput.value || 'all'); } catch (e) {}
        });
      }
    });
  </script>
  <script>
    // Calendar Events Loading
    function loadCalendarEvents() {
      const eventsContainer = document.getElementById('calendar-events');
      const refreshBtn = document.querySelector('button[onclick="loadCalendarEvents()"]');
      
      // Show loading state
      eventsContainer.innerHTML = `
        <div class="card-body text-center text-muted">
          <div class="spinner-border spinner-border-sm me-2" role="status"></div>
          Loading events...
        </div>
      `;
      refreshBtn.disabled = true;
      
      fetch('/api/calendar/events')
        .then(response => response.json())
        .then(events => {
          if (events.length === 0) {
            eventsContainer.innerHTML = `
              <div class="card-body text-center text-muted">
                <i class="fas fa-calendar-check fa-2x mb-2"></i><br>
                No events found for the next 2 weeks
              </div>
            `;
          } else {
            let eventsHTML = '<div class="card-body"><div class="list-group list-group-flush">';
            
            events.forEach((event, index) => {
              const eventDate = new Date(event.start_datetime);
              const isToday = eventDate.toDateString() === new Date().toDateString();
              const isTomorrow = eventDate.toDateString() === new Date(Date.now() + 86400000).toDateString();
              
              let dateDisplay = event.start_date;
              if (isToday) dateDisplay = 'Today';
              else if (isTomorrow) dateDisplay = 'Tomorrow';
              else dateDisplay = `${event.weekday}, ${event.start_date}`;
              
              const borderColor = isToday ? 'border-primary' : '';
              const borderStyle = isToday ? 'border-start border-3' : `border-start border-3`;
              const calendarColor = event.calendar_color || '#3788d8';
              
              eventsHTML += `
                <div class="list-group-item ${borderStyle}" style="border-left-color: ${calendarColor} !important;">
                  <div class="d-flex w-100 justify-content-between align-items-start">
                    <h6 class="mb-1">${event.summary}</h6>
                    <div class="d-flex align-items-center">
                      <div style="width: 12px; height: 12px; background-color: ${calendarColor}; border-radius: 50%; margin-right: 6px;"></div>
                      <small class="text-muted">${event.calendar_name}</small>
                    </div>
                  </div>
                  <div class="d-flex w-100 justify-content-between">
                    <p class="mb-1">
                      <i class="fas fa-clock me-1"></i>${dateDisplay}${event.is_all_day ? '' : ` at ${event.start_time}`}
                      ${event.location ? `<br><i class="fas fa-map-marker-alt me-1"></i>${event.location}` : ''}
                    </p>
                  </div>
                </div>
              `;
            });
            
            eventsHTML += '</div></div>';
            eventsContainer.innerHTML = eventsHTML;
          }
        })
        .catch(error => {
          console.error('Error loading calendar events:', error);
          eventsContainer.innerHTML = `
            <div class="card-body text-center text-danger">
              <i class="fas fa-exclamation-triangle fa-2x mb-2"></i><br>
              Error loading events. Please try again.
            </div>
          `;
        })
        .finally(() => {
          refreshBtn.disabled = false;
        });
    }
    
    // Auto-load events when settings tab is shown and calendars are configured
    document.addEventListener('DOMContentLoaded', function() {
      const settingsTab = document.querySelector('button[data-bs-target="#settings"]');
      if (settingsTab) {
        settingsTab.addEventListener('shown.bs.tab', function() {
          const calendarEventsContainer = document.getElementById('calendar-events');
          if (calendarEventsContainer && {{ config.get('calendar_urls', [])|length > 0 }}) {
            loadCalendarEvents();
          }
        });
      }
      
      // If we're already on the settings tab, load events
      const activeTab = document.querySelector('.nav-link.active[data-bs-target="#settings"]');
      if (activeTab && {{ config.get('calendar_urls', [])|length > 0 }}) {
        loadCalendarEvents();
      }
    });
  </script>
</body>
</html>
